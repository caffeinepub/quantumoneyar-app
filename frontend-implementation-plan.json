{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Full AR Game Rebuild: Real Canister Sync, Playable AR, Correct HUD Coins",
  "requirements": [
    {
      "id": "REQ-29",
      "summary": "Rebuild GameStateContext to fetch all player data exclusively from the backend canister via authenticated actor, removing localStorage-only derivations",
      "acceptanceCriteria": [
        "After login, GameStateContext fetches XP and balances from canister within 3 seconds",
        "Data in GameStateContext matches what the same Principal sees on Quantumoney.app",
        "No XP or balance value is derived from localStorage alone",
        "refetch() re-queries the canister and updates all values",
        "triggerWelcomeBonus calls the canister and does not grant the bonus twice"
      ],
      "file_operations": [
        {
          "path": "frontend/src/contexts/GameStateContext.tsx",
          "operation": "modify",
          "description": "Refactor GameStateContext to fetch XP, lockedQMY, unlockedQMY, capturedMonsters, lockedCoins, and vestingSchedule exclusively from canister via usePlayerState and getVestingSchedule queries. Remove all localStorage-only derivations for these values. Add triggerWelcomeBonus function that calls claimWelcomeBonus backend capability and invalidates playerState query. Ensure context refetches on mount and window focus. Verify the backend interface before implementing."
        }
      ]
    },
    {
      "id": "REQ-30",
      "summary": "Rebuild useArActions.ts so useLockCoin, useUnlockCoin, and useCaptureMonster call real backend actor capabilities and invalidate playerState query on success",
      "acceptanceCriteria": [
        "useLockCoin mutation calls actor.lockCoin(spawnId) with the authenticated actor",
        "useLockCoin on success triggers a re-fetch of player state and XP increments by 10",
        "useUnlockCoin mutation calls actor.unlockCoin(spawnId) and XP decrements by 15 on success",
        "useCaptureMonster mutation calls actor.captureMonster(spawnId) and XP increments by 20 on success",
        "All three mutations show isPending=true during the async call",
        "arInteractionsStore is updated on success for each mutation"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useArActions.ts",
          "operation": "modify",
          "description": "Rebuild useLockCoin, useUnlockCoin, and useCaptureMonster as React Query mutations calling actor.lockCoin(spawnId), actor.unlockCoin(spawnId), and actor.captureMonster(spawnId) respectively. On success, invalidate the playerState query to trigger GameStateContext refresh, and update arInteractionsStore and mockGameplayState as fallback cache. Remove all stub or simulation logic. Verify the backend interface before implementing."
        }
      ]
    },
    {
      "id": "REQ-31",
      "summary": "Rebuild CameraARActionBar to be fully playable with real canister-backed Lock/Unlock/Rescue buttons, loading spinners, and XP change toasts",
      "acceptanceCriteria": [
        "Lock QMY button is visible and clickable only for unlocked coin spawns in AR view",
        "Unlock QMY button is visible and clickable only for already-locked coin spawns in AR view",
        "Rescue Monster button is visible and clickable only for uncaptured monster spawns in AR view",
        "All three buttons show a spinner while the canister mutation is pending",
        "SpawnCollectFX overlay appears after successful monster capture",
        "XP delta toast is displayed after each successful action",
        "Lock/Unlock buttons do not appear anywhere outside the AR camera page"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/sections/CameraAR/CameraARActionBar.tsx",
          "operation": "modify",
          "description": "Rebuild CameraARActionBar to show Lock QMY button for unlocked coins, Unlock QMY button for locked coins, and Rescue Monster button for uncaptured monsters. Call useLockCoin, useUnlockCoin, and useCaptureMonster mutations with the nearest visible spawn's ID. Show loading spinner (isPending state) during mutation. Display SpawnCollectFX after successful monster capture. Show XP change toast (+10, -15, or +20) after each successful mutation. Ensure Lock/Unlock buttons only appear on AR camera page. Verify the component usage instructions for any selected components before implementing."
        }
      ]
    },
    {
      "id": "REQ-32",
      "summary": "Rebuild spawn data layer to fetch canonical spawn list from canister via getSpawnList, using mockSpawns.ts only as fallback when canister is unreachable",
      "acceptanceCriteria": [
        "useSpawnList hook calls actor.getSpawnList() when authenticated actor is available",
        "AR overlay and Leaflet map use canister spawn data when available",
        "mockSpawns.ts is only used when the canister call returns an error",
        "mockSpawns.ts file contains a visible comment marking it as fallback-only",
        "Spawns loaded from the canister include the same IDs as on Quantumoney.app"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useSpawnList.ts",
          "operation": "create",
          "description": "Create React Query hook useSpawnList that calls actor.getSpawnList() when authenticated actor is available. Return spawn list from canister response. On error, fall back to mockSpawns list. Expose spawn data as query result with isLoading, error, and data states. Verify the backend interface before implementing."
        },
        {
          "path": "frontend/src/lib/mockSpawns.ts",
          "operation": "modify",
          "description": "Add a prominent comment at the top of the file: '// FALLBACK ONLY â€” used when canister is unreachable'. Ensure the file structure matches the SpawnItem interface from backend.d.ts (id, latitude, longitude, itemType, spawnType, attributes). Keep all existing spawn data intact."
        },
        {
          "path": "frontend/src/components/sections/CameraAR/CameraARPage.tsx",
          "operation": "modify",
          "description": "Integrate useSpawnList hook to provide canister-backed spawn data to AR overlay and action bar. Pass spawn list to OverlayLayer and useArVisibility. Handle loading and error states gracefully. Verify the component usage instructions for any selected components before implementing."
        },
        {
          "path": "frontend/src/components/sections/MapMundoLeaflet.tsx",
          "operation": "modify",
          "description": "Integrate useSpawnList hook to provide canister-backed spawn data to the Leaflet map iframe via postMessage. When spawn data changes, send updated list to map.js. Handle loading and error states gracefully. Verify the component usage instructions for any selected components before implementing."
        }
      ]
    },
    {
      "id": "REQ-33",
      "summary": "Rebuild HUD page to remove floating coins, display static realistic QMY coin images, show canister-backed XP/balances, add Quantumoney.app link, and trigger welcome bonus on first login",
      "acceptanceCriteria": [
        "No floating/drifting coin animation elements are rendered on the HUD page",
        "At least one realistic static QMY coin image is displayed on the HUD",
        "Stars, planets, and comets background animation is still active",
        "XP, locked QMY, and unlocked QMY values shown on HUD come from GameStateContext (canister-backed)",
        "'Go to Quantumoney.app' button opens https://quantumoney.app in a new tab",
        "WelcomeBonusModal appears on first login and is not shown again after dismissal"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/sections/HUD.tsx",
          "operation": "modify",
          "description": "Remove all floating/drifting animated coin graphics from HUD page. Replace with static realistic QMY coin images from frontend/public/assets/generated/qmy-coin-3d.dim_256x256.png displayed as decorative elements (e.g., a row or cluster). Keep HomeSpaceBackground active for stars/planets/comets. Display xp, lockedQMY, unlockedQMY from GameStateContext (canister-backed). Add a 'Go to Quantumoney.app' button that opens https://quantumoney.app in a new tab. On first login (check if player has claimed welcome bonus via GameStateContext), call triggerWelcomeBonus and show WelcomeBonusModal. Verify the component usage instructions for any selected components before implementing."
        }
      ]
    },
    {
      "id": "REQ-34",
      "summary": "Rebuild Profile page to read all data exclusively from canister, enable inline display name editing, and support profile photo upload",
      "acceptanceCriteria": [
        "Profile page shows XP value matching getPlayerState canister response",
        "Locked and unlocked QMY balances on Profile page match canister data",
        "Display name is loaded from getUserProfile and editable inline with save persisted to canister",
        "Profile photo is uploaded to and loaded from the canister blob storage",
        "Vesting schedule displayed on Profile page matches getVestingSchedule canister response",
        "No profile value is derived from localStorage alone"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/sections/Profile.tsx",
          "operation": "modify",
          "description": "Rebuild Profile page to read displayName via getCallerUserProfile query, and XP, lockedQMY, unlockedQMY, capturedMonsters count, vestingSchedule from GameStateContext. Make displayName editable inline and save via setDisplayName mutation. Add profile photo upload using blob-storage component: on file select, create ExternalBlob.fromBytes(data).withUploadProgress(), call setProfilePhoto mutation, and display the uploaded photo via getDirectURL(). Fall back to default avatar if no photo. Remove all localStorage-only derivations. Verify the blob-storage component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-35",
      "summary": "Rebuild Leaflet map integration so spawn markers reflect real-time lock and capture states from canister via arInteractionsStore",
      "acceptanceCriteria": [
        "Locked coins appear with a locked icon on the Leaflet map",
        "Captured monsters appear with a captured icon on the Leaflet map",
        "Map state updates within 5 seconds of a lock/unlock/capture action in AR",
        "map.js reads arInteractionsStore from localStorage to render correct marker states",
        "MapMundoLeaflet sends postMessage with updated state on localStorage change"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/sections/MapMundoLeaflet.tsx",
          "operation": "modify",
          "description": "Rebuild MapMundoLeaflet to listen for arInteractionsStore changes via storage event listener. On change, send postMessage to map.js iframe with updated locked coin IDs and captured monster IDs. Ensure postMessage is sent on component mount with initial state. Verify the component usage instructions for any selected components before implementing."
        },
        {
          "path": "frontend/public/map/map.js",
          "operation": "modify",
          "description": "Modify map.js to read arInteractionsStore from localStorage on load and on postMessage receipt. Update coin markers to show locked icon (frontend/public/assets/generated/map-locked-qmy-coin-gold.dim_32x32.png) when coin ID is in lockedCoins array. Update monster markers to show captured icon when monster ID is in capturedMonsters array. Re-render markers when state changes. Verify the component usage instructions for any selected components before implementing."
        }
      ]
    },
    {
      "id": "REQ-36",
      "summary": "Wire the generated realistic 3D-style golden QMY coin image into the HUD page as a static decorative asset",
      "acceptanceCriteria": [
        "A QMY coin image asset is present in frontend/public/assets/generated/",
        "The coin image is rendered on the HUD page as a static decorative element",
        "The coin has a gold metallic appearance with 'QMY' visible on its face"
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/sections/HUD.tsx",
          "operation": "modify",
          "description": "Import and render the generated QMY coin image at frontend/public/assets/generated/qmy-coin-3d.dim_256x256.png as a static decorative element on the HUD page. Display as a cluster or row of 3D-style coins positioned prominently (e.g., top-right corner or center banner). Use img tag with explicit width/height to prevent layout shift. Verify the component usage instructions for any selected components before implementing."
        }
      ]
    }
  ]
}